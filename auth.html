<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Mist & Matter</title>
<link rel="stylesheet" href="styles.css">
<style>
body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.auth-container { max-width: 420px; width: 90%; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
.auth-header { text-align: center; margin-bottom: 30px; }
.auth-header img { width: 60px; height: 60px; margin-bottom: 10px; }
.auth-header h2 { margin: 0 0 5px; color: #111; font-size: 24px; }
.auth-header p { margin: 0; color: #666; font-size: 14px; }
.auth-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
.auth-tab { flex: 1; padding: 12px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; color: #666; transition: all 0.3s; }
.auth-tab.active { background: #667eea; color: white; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; font-size: 14px; }
.form-group input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: border 0.3s; }
.form-group input:focus { outline: none; border-color: #667eea; }
.btn { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
.btn:hover { background: #5568d3; }
.btn:disabled { background: #ccc; cursor: not-allowed; }
.signup-form, .forgot-form { display: none; }
.back-link { text-align: center; margin-top: 20px; }
.back-link a { color: #667eea; text-decoration: none; font-size: 14px; font-weight: 500; }
.forgot-link { text-align: right; margin-top: -10px; margin-bottom: 20px; }
.forgot-link a { color: #667eea; text-decoration: none; font-size: 13px; cursor: pointer; }
.divider { text-align: center; margin: 20px 0; color: #999; font-size: 13px; }
</style>
</head>
<body>

<div class="auth-container">
  <div class="auth-header">
    <img src="logo3.png" alt="Mist & Matter">
    <h2>Mist & Matter</h2>
    <p>Premium Fabric Care</p>
  </div>
  
  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchTab('signin')">SIGN IN</button>
    <button class="auth-tab" onclick="switchTab('signup')">SIGN UP</button>
  </div>
  
  <!-- SIGN IN FORM -->
  <form id="signinForm" class="signin-form" onsubmit="handleSignIn(event)">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="signinEmail" placeholder="Enter your email" required>
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="signinPassword" placeholder="Enter your password" required>
    </div>
    <div class="forgot-link">
      <a onclick="showForgotPassword()">Forgot Password?</a>
    </div>
    <button type="submit" class="btn">SIGN IN</button>
  </form>
  
  <!-- SIGN UP FORM -->
  <form id="signupForm" class="signup-form" onsubmit="handleSignUp(event)">
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="signupName" placeholder="Enter your full name" required>
    </div>
    <div class="form-group">
      <label>Date of Birth</label>
      <input type="date" id="signupDob" required>
    </div>
    <div class="form-group">
      <label>Phone Number</label>
      <input type="tel" id="signupPhone" placeholder="10 digit mobile number" maxlength="10" pattern="[0-9]{10}" required>
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="signupEmail" placeholder="Enter your email" required>
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="signupPassword" placeholder="Create a password (min 6 characters)" minlength="6" required>
    </div>
    <button type="submit" class="btn">CREATE ACCOUNT</button>
  </form>
  
  <!-- FORGOT PASSWORD FORM -->
  <form id="forgotForm" class="forgot-form" onsubmit="handleForgotPassword(event)">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="forgotEmail" placeholder="Enter your registered email" required>
    </div>
    <div class="form-group">
      <label>New Password</label>
      <input type="password" id="forgotPassword" placeholder="Enter new password (min 6 characters)" minlength="6" required>
    </div>
    <button type="submit" class="btn">RESET PASSWORD</button>
    <div style="text-align:center;margin-top:15px;">
      <a onclick="switchTab('signin')" style="color:#667eea;cursor:pointer;font-size:14px;">← Back to Sign In</a>
    </div>
  </form>
  
  <div class="back-link">
    <a href="index.html">← Back to Shopping</a>
  </div>
</div>

<script>
const API_URL = 'https://mnm-orders-api.mistnmatter.workers.dev';

function switchTab(tab) {
  const tabs = document.querySelectorAll('.auth-tab');
  tabs.forEach(t => t.classList.remove('active'));
  
  document.getElementById('signinForm').style.display = 'none';
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('forgotForm').style.display = 'none';
  
  if (tab === 'signin') {
    tabs[0].classList.add('active');
    document.getElementById('signinForm').style.display = 'block';
  } else if (tab === 'signup') {
    tabs[1].classList.add('active');
    document.getElementById('signupForm').style.display = 'block';
  }
}

function showForgotPassword() {
  const tabs = document.querySelectorAll('.auth-tab');
  tabs.forEach(t => t.classList.remove('active'));
  
  document.getElementById('signinForm').style.display = 'none';
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('forgotForm').style.display = 'block';
}

async function handleSignIn(event) {
  event.preventDefault();
  
  const email = document.getElementById('signinEmail').value.trim();
  const password = document.getElementById('signinPassword').value;
  
  try {
    const response = await fetch(`${API_URL}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Save user data
      localStorage.setItem('mm_user_name', result.user.name);
      localStorage.setItem('mm_user_phone', result.user.phone);
      localStorage.setItem('mm_user_email', result.user.email);
      localStorage.setItem('mm_user_logged_in', 'true');
      localStorage.setItem('mm_user_id', result.user.id);
      localStorage.setItem('mm_auth_token', result.token);
      
      showToast('✅ Login successful!');
      
      // Check if coming from checkout flow
      const hasCheckoutData = localStorage.getItem('checkout_data');
      
      setTimeout(() => {
        if (hasCheckoutData) {
          window.location.href = 'checkout-address.html';
        } else {
          window.location.href = 'index.html';
        }
      }, 500);
    } else {
      showToast('❌ ' + (result.error || 'Invalid credentials'));
    }
  } catch (error) {
    console.error('Login error:', error);
    showToast('❌ Login failed. Please try again.');
  }
}

async function handleSignUp(event) {
  event.preventDefault();
  
  const name = document.getElementById('signupName').value.trim();
  const dob = document.getElementById('signupDob').value;
  const phone = document.getElementById('signupPhone').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  
  if (!/^[0-9]{10}$/.test(phone)) {
    showToast('❌ Please enter valid 10 digit phone number');
    return;
  }
  
  try {
    const response = await fetch(`${API_URL}/api/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, dob, phone, email, password })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Save user data
      localStorage.setItem('mm_user_name', result.user.name);
      localStorage.setItem('mm_user_phone', result.user.phone);
      localStorage.setItem('mm_user_email', result.user.email);
      localStorage.setItem('mm_user_logged_in', 'true');
      localStorage.setItem('mm_user_id', result.user.id);
      localStorage.setItem('mm_auth_token', result.token);
      
      showToast('✅ Account created successfully!');
      
      // Check if coming from checkout flow
      const hasCheckoutData = localStorage.getItem('checkout_data');
      
      setTimeout(() => {
        if (hasCheckoutData) {
          window.location.href = 'checkout-address.html';
        } else {
          window.location.href = 'index.html';
        }
      }, 500);
    } else {
      showToast('❌ ' + (result.error || 'Registration failed'));
    }
  } catch (error) {
    console.error('Registration error:', error);
    showToast('❌ Registration failed. Please try again.');
  }
}

async function handleForgotPassword(event) {
  event.preventDefault();
  
  const email = document.getElementById('forgotEmail').value.trim();
  const newPassword = document.getElementById('forgotPassword').value;
  
  try {
    const response = await fetch(`${API_URL}/api/auth/reset-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, newPassword })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('✅ Password reset successful! Please sign in.');
      setTimeout(() => {
        document.getElementById('forgotForm').reset();
        switchTab('signin');
      }, 1500);
    } else {
      showToast('❌ ' + (result.error || 'Password reset failed'));
    }
  } catch (error) {
    console.error('Reset error:', error);
    showToast('❌ Password reset failed. Please try again.');
  }
}

function showToast(msg) {
  const div = document.createElement('div');
  div.innerText = msg;
  div.style.cssText = `
    position:fixed;
    bottom:30px;
    left:50%;
    transform:translateX(-50%);
    background:#111;
    color:#fff;
    padding:12px 20px;
    font-size:14px;
    border-radius:8px;
    z-index:10000;
    max-width:90%;
    text-align:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
  `;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}
</script>

</body>
</html>
